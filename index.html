<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>太魯閣語多模態語料庫搜尋 Truku MMOC Search</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; background: #f5f5f5; color: #333; }
header { background: #2c3e50; color: white; padding: 16px 24px; }
header h1 { font-size: 1.3em; }
header p { font-size: 0.85em; opacity: 0.8; margin-top: 4px; }

.container { max-width: 1200px; margin: 0 auto; padding: 16px; }

/* Search */
.search-box { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; }
.search-row { display: flex; gap: 8px; margin-bottom: 12px; }
.search-row input[type="text"] { flex: 1; padding: 10px 14px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em; }
.search-row input[type="text"]:focus { border-color: #3498db; outline: none; }
.search-row button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; }
.search-row button:hover { background: #2980b9; }
.search-row button.secondary { background: #95a5a6; }
.search-row button.secondary:hover { background: #7f8c8d; }

.mode-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
.mode-row label { cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.9em; }

.gesture-panel { margin-top: 12px; display: none; flex-wrap: wrap; gap: 6px; }
.gesture-panel.active { display: flex; }
.gesture-panel label { background: #ecf0f1; padding: 4px 10px; border-radius: 4px; font-size: 0.82em; cursor: pointer; }
.gesture-panel input:checked + span { color: #2c3e50; font-weight: bold; }

.ipa-panel { margin-top: 12px; display: none; flex-wrap: wrap; gap: 4px; }
.ipa-panel.active { display: flex; }
.ipa-panel button { padding: 4px 10px; border: 1px solid #bdc3c7; border-radius: 4px; background: white; cursor: pointer; font-size: 0.95em; font-family: "Noto Sans", monospace; }
.ipa-panel button:hover { background: #eaf2f8; }

.stats-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.85em; color: #7f8c8d; }
.stats-bar button { padding: 4px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.82em; }

/* Results */
.results { display: flex; flex-direction: column; gap: 8px; }
.result-card { background: white; border-radius: 8px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); cursor: pointer; transition: box-shadow 0.2s; }
.result-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.result-card.selected { border-left: 4px solid #3498db; cursor: default; }
.result-time { font-size: 0.8em; color: #7f8c8d; margin-bottom: 4px; }
.result-truku { font-size: 1em; margin-bottom: 2px; }
.result-truku mark { background: #ffeaa7; }
.result-chinese { font-size: 0.9em; color: #636e72; margin-bottom: 6px; }
.result-chinese mark { background: #ffeaa7; }
.result-meta { font-size: 0.78em; color: #95a5a6; }
.result-meta .phone-seq { font-family: monospace; letter-spacing: 1px; }
.result-meta .gesture-tags span { display: inline-block; background: #dfe6e9; padding: 1px 6px; border-radius: 3px; margin: 1px; font-size: 0.85em; }
.result-meta .gesture-tags span.matched { background: #74b9ff; color: white; }

/* Inline player */
.inline-player { margin-top: 12px; border-top: 1px solid #ecf0f1; padding-top: 12px; }
.player-layout { display: flex; gap: 16px; }
.player-layout video { width: 420px; min-width: 300px; aspect-ratio: 4/3; border-radius: 6px; background: black; flex-shrink: 0; display: block; }
.player-details { flex: 1; min-width: 0; max-height: 300px; overflow-y: auto; }
.tier { margin-bottom: 8px; }
.tier-label { font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; font-weight: 600; }
.tier-content { font-size: 0.88em; line-height: 1.5; word-break: break-word; }
.phone-detail { font-family: monospace; letter-spacing: 1px; font-size: 0.85em; }
.gesture-detail span { display: inline-block; background: #dfe6e9; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.8em; }
.no-data { color: #bdc3c7; font-style: italic; font-size: 0.85em; }

@media (max-width: 768px) {
  .player-layout { flex-direction: column; }
  .player-layout video { width: 100%; }
}
</style>
</head>
<body>

<header>
  <h1>太魯閣語多模態語料庫搜尋</h1>
  <p>Truku Multimodal Corpus Search</p>
</header>

<div class="container">
  <div class="search-box">
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="輸入搜尋文字..." autofocus>
      <button onclick="doSearch()">搜尋</button>
      <button class="secondary" onclick="clearSearch()">清除</button>
    </div>
    <div class="mode-row">
      <label><input type="radio" name="mode" value="truku" checked onchange="onModeChange()"> 太魯閣語</label>
      <label><input type="radio" name="mode" value="chinese" onchange="onModeChange()"> 中文翻譯</label>
      <label><input type="radio" name="mode" value="phone" onchange="onModeChange()"> 音素</label>
      <label><input type="radio" name="mode" value="allophone" onchange="onModeChange()"> 同位音 (IPA)</label>
      <label><input type="radio" name="mode" value="gesture" onchange="onModeChange()"> 手勢</label>
    </div>
    <div class="ipa-panel" id="ipaPanel"></div>
    <div class="gesture-panel" id="gesturePanel"></div>
  </div>

  <div class="stats-bar">
    <span id="statsText">載入中...</span>
    <button onclick="exportCSV()">匯出 CSV</button>
  </div>

  <div class="results" id="resultsList"></div>
</div>

<script>
let corpus = null;
let currentResults = [];
let selectedIdx = -1;
const VIDEO_SRC = "full_video.mp4";
let sharedVideo = null;
let sharedVideoSrc = "";
let sharedVideoHandlers = null;

function getSharedVideo() {
  if (!sharedVideo) {
    sharedVideo = document.createElement("video");
    sharedVideo.controls = true;
    sharedVideo.playsInline = true;
    sharedVideo.preload = "auto";
    sharedVideo.width = 420;
    sharedVideo.height = 315;
  }
  return sharedVideo;
}

function clearSharedVideoHandlers() {
  if (!sharedVideo || !sharedVideoHandlers) return;
  const { onMeta, onSeeked, onTime } = sharedVideoHandlers;
  if (onMeta) sharedVideo.removeEventListener("loadedmetadata", onMeta);
  if (onSeeked) sharedVideo.removeEventListener("seeked", onSeeked);
  if (onTime) sharedVideo.removeEventListener("timeupdate", onTime);
  sharedVideoHandlers = null;
}

function playSegment(startTime, endTime) {
  const vid = getSharedVideo();
  clearSharedVideoHandlers();

  if (sharedVideoSrc !== VIDEO_SRC) {
    vid.src = VIDEO_SRC;
    sharedVideoSrc = VIDEO_SRC;
    vid.load();
  }

  const onSeeked = function() {
    vid.removeEventListener("seeked", onSeeked);
    vid.play().catch(function() {});
  };

  const onTime = function() {
    if (vid.currentTime >= endTime) {
      vid.pause();
      vid.removeEventListener("timeupdate", onTime);
    }
  };

  let onMeta = null;
  if (vid.readyState >= 1) {
    vid.currentTime = startTime;
  } else {
    onMeta = function() {
      vid.removeEventListener("loadedmetadata", onMeta);
      vid.currentTime = startTime;
    };
    vid.addEventListener("loadedmetadata", onMeta);
  }

  vid.addEventListener("seeked", onSeeked);
  vid.addEventListener("timeupdate", onTime);
  sharedVideoHandlers = { onMeta, onSeeked, onTime };
}

fetch("corpus.json")
  .then(r => r.json())
  .then(data => {
    corpus = data;
    document.getElementById("statsText").textContent =
      `共 ${corpus.utterances.length} 筆語句 | 手勢 ${corpus.gestureInventory.length} 種 | 音素 ${corpus.phoneInventory.length} 種 | 同位音 ${corpus.allophoneInventory.length} 種`;
    buildGesturePanel();
    buildIPAPanel();
    showAll();
  })
  .catch(e => {
    document.getElementById("statsText").textContent = "載入 corpus.json 失敗: " + e.message;
  });

function buildGesturePanel() {
  document.getElementById("gesturePanel").innerHTML = corpus.gestureInventory.map(g =>
    `<label><input type="checkbox" value="${g}"><span>${g}</span></label>`
  ).join("");
}

function buildIPAPanel() {
  document.getElementById("ipaPanel").innerHTML = corpus.allophoneInventory.map(a =>
    `<button type="button" onclick="insertIPA('${a.replace(/'/g, "\\'")}')">${a}</button>`
  ).join("");
}

function insertIPA(char) {
  const input = document.getElementById("searchInput");
  const pos = input.selectionStart;
  const val = input.value;
  input.value = val.slice(0, pos) + char + val.slice(pos);
  input.focus();
  input.selectionStart = input.selectionEnd = pos + char.length;
}

function onModeChange() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  document.getElementById("gesturePanel").classList.toggle("active", mode === "gesture");
  document.getElementById("ipaPanel").classList.toggle("active", mode === "allophone");
  document.getElementById("searchInput").placeholder = ({
    truku: "輸入太魯閣語文字...", chinese: "輸入中文翻譯...",
    phone: "輸入音素序列（如 ami 或 a m i）...",
    allophone: "輸入同位音序列（點擊下方 IPA 按鈕）...",
    gesture: "勾選下方手勢標籤...",
  })[mode] || "";
}

function fmt(sec) {
  return `${Math.floor(sec/60).toString().padStart(2,"0")}:${Math.floor(sec%60).toString().padStart(2,"0")}`;
}

function esc(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function highlight(text, query, active) {
  if (!query || !active) return esc(text);
  const e = esc(text), q = esc(query);
  return e.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"), "<mark>$1</mark>");
}

function showAll() {
  currentResults = corpus.utterances.map((u, i) => ({ utt: u, idx: i }));
  selectedIdx = -1;
  renderResults();
}

function doSearch() {
  if (!corpus) return;
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const query = document.getElementById("searchInput").value.trim();

  if (mode === "gesture") {
    const checked = [...document.querySelectorAll("#gesturePanel input:checked")].map(c => c.value);
    if (!checked.length) { showAll(); return; }
    currentResults = corpus.utterances.map((u,i)=>({utt:u,idx:i})).filter(({utt}) => {
      const s = new Set();
      (utt.gestures_sp1||[]).forEach(g=>g.labels.forEach(l=>s.add(l)));
      (utt.gestures_sp2||[]).forEach(g=>g.labels.forEach(l=>s.add(l)));
      return checked.every(c=>s.has(c));
    });
  } else if (mode === "truku" || mode === "chinese") {
    if (!query) { showAll(); return; }
    const f = mode === "truku" ? "truku" : "chinese", q = query.toLowerCase();
    currentResults = corpus.utterances.map((u,i)=>({utt:u,idx:i})).filter(({utt})=>utt[f].toLowerCase().includes(q));
  } else if (mode === "phone" || mode === "allophone") {
    if (!query) { showAll(); return; }
    const f = mode === "phone" ? "phones" : "allophones";
    const qp = query.includes(" ") ? query.split(/\s+/) : [...query];
    currentResults = corpus.utterances.map((u,i)=>({utt:u,idx:i})).filter(({utt}) => {
      const items = utt[f];
      for (let j=0; j<=items.length-qp.length; j++) {
        let ok=true;
        for (let k=0;k<qp.length;k++) if(items[j+k].l!==qp[k]){ok=false;break;}
        if(ok) return true;
      }
      return false;
    });
  }
  selectedIdx = -1;
  renderResults();
}

function renderResults() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const query = document.getElementById("searchInput").value.trim();
  const gc = mode==="gesture" ? new Set([...document.querySelectorAll("#gesturePanel input:checked")].map(c=>c.value)) : new Set();

  document.getElementById("statsText").textContent = `搜尋結果: ${currentResults.length} / ${corpus.utterances.length} 筆`;

  const html = currentResults.map(({utt, idx}) => {
    const ps = utt.phones.map(p=>p.l).join(" ");
    const gl = new Set();
    (utt.gestures_sp1||[]).forEach(g=>g.labels.forEach(l=>gl.add(l)));
    (utt.gestures_sp2||[]).forEach(g=>g.labels.forEach(l=>gl.add(l)));
    const gt = [...gl].map(l=>`<span class="${gc.has(l)?"matched":""}">${l}</span>`).join("");

    return `<div class="result-card" data-idx="${idx}" id="result-${idx}">
      <div class="result-time">${fmt(utt.start)} - ${fmt(utt.end)}</div>
      <div class="result-truku">${highlight(utt.truku, query, mode==="truku")}</div>
      <div class="result-chinese">${highlight(utt.chinese, query, mode==="chinese")}</div>
      <div class="result-meta">
        ${ps ? `<div class="phone-seq">${esc(ps.substring(0,80))}${ps.length>80?"...":""}</div>` : ""}
        ${gt ? `<div class="gesture-tags">${gt}</div>` : ""}
      </div>
    </div>`;
  }).join("");

  document.getElementById("resultsList").innerHTML = html || '<div class="no-data">沒有找到匹配的結果</div>';

  // Bind click on cards
  document.querySelectorAll(".result-card").forEach(card => {
    card.addEventListener("click", () => selectResult(parseInt(card.dataset.idx)));
  });
}

function selectResult(idx) {
  if (idx === selectedIdx) return;

  // 1. Collapse previous selection
  const prev = document.querySelector(".result-card.selected");
  if (prev) {
    prev.classList.remove("selected");
    const oldPlayer = prev.querySelector(".inline-player");
    if (oldPlayer) {
      if (sharedVideo && oldPlayer.contains(sharedVideo)) {
        sharedVideo.pause();
        clearSharedVideoHandlers();
        const slot = oldPlayer.querySelector(".video-slot");
        if (slot && slot.contains(sharedVideo)) slot.removeChild(sharedVideo);
      }
      oldPlayer.remove();
    }
  }

  selectedIdx = idx;
  const utt = corpus.utterances[idx];
  const card = document.getElementById("result-" + idx);
  if (!card) return;

  card.classList.add("selected");

  // 2. Build inline player HTML
  const phoneDetail = utt.phones.length ? utt.phones.map(p=>p.l).join(" ") : "(此段無音素資料)";
  const alloDetail = utt.allophones.length ? utt.allophones.map(a=>a.l).join(" ") : "(此段無同位音資料)";

  const gestureHTML = (arr) => {
    if (!arr || !arr.length) return '<span class="no-data">(此段無手勢資料)</span>';
    return arr.map(g =>
      `<div>[${fmt(g.start)}-${fmt(g.end)}] ${g.labels.map(l=>`<span>${l}</span>`).join(" ")}</div>`
    ).join("");
  };

  const playerDiv = document.createElement("div");
  playerDiv.className = "inline-player";
  playerDiv.innerHTML = `
    <div class="player-layout">
      <div class="video-slot"></div>
      <div class="player-details">
        <div class="tier"><div class="tier-label">太魯閣語 Truku</div><div class="tier-content">${esc(utt.truku)}</div></div>
        <div class="tier"><div class="tier-label">中文翻譯</div><div class="tier-content">${esc(utt.chinese)}</div></div>
        <div class="tier"><div class="tier-label">音素 Phones</div><div class="tier-content phone-detail">${esc(phoneDetail)}</div></div>
        <div class="tier"><div class="tier-label">同位音 Allophones (IPA)</div><div class="tier-content phone-detail">${esc(alloDetail)}</div></div>
        <div class="tier"><div class="tier-label">手勢 SP1</div><div class="tier-content gesture-detail">${gestureHTML(utt.gestures_sp1)}</div></div>
        <div class="tier"><div class="tier-label">手勢 SP2</div><div class="tier-content gesture-detail">${gestureHTML(utt.gestures_sp2)}</div></div>
      </div>
    </div>`;
  card.appendChild(playerDiv);

  // 3. Use JavaScript seeking instead of unreliable #t= media fragments
  const startTime = utt.start;
  const endTime = utt.end;

  const slot = playerDiv.querySelector(".video-slot");
  const vid = getSharedVideo();
  slot.appendChild(vid);
  playSegment(startTime, endTime);

  // Scroll into view
  card.scrollIntoView({ behavior: "smooth", block: "nearest" });
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  document.querySelectorAll("#gesturePanel input").forEach(c => c.checked = false);
  selectedIdx = -1;
  showAll();
}

function exportCSV() {
  if (!currentResults.length) return;
  const BOM = "\uFEFF";
  const h = ["start","end","truku","chinese","phones","allophones","gestures_sp1","gestures_sp2"];
  const rows = currentResults.map(({utt}) => {
    const e = s => `"${(s||"").replace(/"/g,'""')}"`;
    return [utt.start, utt.end, e(utt.truku), e(utt.chinese),
      e(utt.phones.map(p=>p.l).join(" ")), e(utt.allophones.map(a=>a.l).join(" ")),
      e((utt.gestures_sp1||[]).map(g=>g.labels.join("|")).join("; ")),
      e((utt.gestures_sp2||[]).map(g=>g.labels.join("|")).join("; "))
    ].join(",");
  });
  const csv = BOM + h.join(",") + "\n" + rows.join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8"}));
  a.download = "truku_corpus_search.csv";
  a.click();
}

document.getElementById("searchInput").addEventListener("keydown", e => { if(e.key==="Enter") doSearch(); });
</script>

</body>
</html>
